     1 00000000                                 ; SugarOS IPL
     2 00000000                                 ; TAB=4
     3 00000000                                 
     4  = 0000000A                                      CYLS      EQU      10      ; 磁盘总煮柱面数位10
     5                                                  ORG       0x7c00           ; 指明程序的装载地址
     6 00007C00                                 
     7 00007C00                                 ; FAT12引导区设置
     8 00007C00                                 
     9 00007C00 EB 4E                                   JMP       entry            ; 跳转到标号entry
    10 00007C02 90                                      DB        0x90             ; 固定写法
    11 00007C03 53 55 47 41 52 4F 53 20                 DB        "SUGAROS "       ; 启动区名称(8字节)
    12 00007C0B 0200                                    DW        512              ; 扇区大小
    13 00007C0D 01                                      DB        1                ; 簇大小
    14 00007C0E 0001                                    DW        1                ; FAT起始位置
    15 00007C10 02                                      DB        2                ; FAT个数
    16 00007C11 00E0                                    DW        224              ; 根目录大小
    17 00007C13 0B40                                    DW        2880             ; 磁盘大小
    18 00007C15 F0                                      DB        0xf0             ; 磁盘种类
    19 00007C16 0009                                    DW        9                ; FAT长度
    20 00007C18 0012                                    DW        18               ; 每磁道扇区数
    21 00007C1A 0002                                    DW        2                ; 磁头数
    22 00007C1C 00000000                                DD        0                ; 是否使用分区
    23 00007C20 00000B40                                DD        2880             ; 重写一次磁盘大小
    24 00007C24 00 00 29                                DB        0,0,0x29         ; 固定写法
    25 00007C27 FFFFFFFF                                DD        0xffffffff       ; 卷标号码
    26 00007C2B 53 55 47 41 52 4F 53 20 20 20           DB        "SUGAROS    "    ; 磁盘名称(11字节)
       00007C35 20 
    27 00007C36 46 41 54 31 32 20 20 20                 DB        "FAT12   "       ; 磁盘格式名称(8字节)
    28 00007C3E 00 00 00 00 00 00 00 00 00 00           RESB      18               ; 空出18字节
       00007C48 00 00 00 00 00 00 00 00 
    29 00007C50                                 
    30 00007C50                                 ; 程序主体
    31 00007C50                                 
    32 00007C50                                 entry:
    33 00007C50 B8 0000                                 MOV       AX,0             ; 初始化寄存器
    34 00007C53 8E D0                                   MOV       SS,AX            ; 初始化寄存器
    35 00007C55 8E D8                                   MOV       DS,AX            ; 初始化寄存器
    36 00007C57 BC 7C00                                 MOV       SP,0x7c00        ; 将栈顶指针(Stack Pointer,SP寄存器)移到ORG
    37 00007C5A                                 
    38 00007C5A                                         ; 读盘
    39 00007C5A                                 
    40 00007C5A B8 0820                                 MOV       AX,0x0820        ; 临时变量
    41 00007C5D 8E C0                                   MOV       ES,AX            ; 读取数据将要缓冲到0x8200(0x0820<<1)-0x83ff
    42 00007C5F B5 00                                   MOV       CH,0             ; 柱面0
    43 00007C61 B6 00                                   MOV       DH,0             ; 磁头0
    44 00007C63 B1 02                                   MOV       CL,2             ; 扇区2
    45 00007C65                                 
    46 00007C65                                 readloop:
    47 00007C65 BE 0000                                 MOV       SI,0             ; 错误次数:0次
    48 00007C68                                 
    49 00007C68                                 retry:
    50 00007C68 B4 02                                   MOV       AH,0x02          ; 读盘(AH=0x02)
    51 00007C6A B0 01                                   MOV       AL,1             ; 读1个扇区
    52 00007C6C BB 0000                                 MOV       BX,0             ; 空闲
    53 00007C6F B2 00                                   MOV       DL,0x00          ; 驱动器A
    54 00007C71                                 
    55 00007C71 CD 13                                   INT       0x13             ; 调用磁盘BIOS
    56 00007C73 73 10                                   JNC       next             ; 如果没出错就跳转到fin
    57 00007C75 83 C6 01                                ADD       SI,1             ; 否则SI加1
    58 00007C78 83 FE 05                                CMP       SI,5             ; 比较SI和5
    59 00007C7B 73 32                                   JAE       error            ; 如果SI >= 5,跳转到error
    60 00007C7D                                         
    61 00007C7D B4 00                                   MOV       AH,0x00          ; 重置驱动器(AH=0x00),为下一次read做准备
    62 00007C7F B2 00                                   MOV       DL,0x00          ; 驱动器A
    63 00007C81 CD 13                                   INT       0x13             ; 调用磁盘BIOS
    64 00007C83 EB E3                                   JMP       retry            ; 继续重读
    65 00007C85                                 
    66 00007C85                                 next:
    67 00007C85 8C C0                                   MOV       AX,ES            ; 将ES移到到AX
    68 00007C87 05 0020                                 ADD       AX,0x0020        ; 将内存后移0x200(AX+=0x20)
    69 00007C8A 8E C0                                   MOV       ES,AX            ; 将AX移回ES
    70 00007C8C 80 C1 01                                ADD       CL,1             ; 扇区 += 1
    71 00007C8F 80 F9 12                                CMP       CL,18            ; 比较扇区和18
    72 00007C92 76 D1                                   JBE       readloop         ; 当扇区 <= 18时，继续读取下一个扇区
    73 00007C94                                 
    74 00007C94                                         ; 否则说明柱面0磁头0已经读完
    75 00007C94                                 
    76 00007C94 B1 01                                   MOV       CL,1             ; 扇区位置归1
    77 00007C96 80 C6 01                                ADD       DH,1             ; 磁头 += 1
    78 00007C99 80 FE 02                                CMP       DH,2             ; 比较磁头和2
    79 00007C9C 72 C7                                   JB        readloop         ; 当磁头 < 2时,继续读下一个磁头
    80 00007C9E                                 
    81 00007C9E                                         ; 否则说明柱面0已经读完
    82 00007C9E                                 
    83 00007C9E B6 00                                   MOV       DH,0             ; 磁头归0
    84 00007CA0 80 C5 01                                ADD       CH,1             ; 柱面 += 1
    85 00007CA3 80 FD 0A                                CMP       CH,CYLS          ; 比较柱面和CYLS总柱面数
    86 00007CA6 72 BD                                   JB        readloop         ; 当柱面小于CYLS总柱面数时,继续读下一个柱面
    87 00007CA8                                 
    88 00007CA8                                 fin:
    89 00007CA8 88 2E 0FF0                              MOV       [0x0ff0],CH      ; 保存CYLS的值
    90 00007CAC E9 4551                                 JMP       0xc200           ; 开始运行载入的程序
    91 00007CAF                                 
    92 00007CAF                                 error:
    93 00007CAF BE 7CC4                                 MOV       SI,msg           ; 指定错误信息字符串地址
    94 00007CB2                                 
    95 00007CB2                                 putloop:
    96 00007CB2 8A 04                                   MOV       AL,[SI]          ; 读取第SI号内存(RAM[SI])的值到AL寄存器
    97 00007CB4 83 C6 01                                ADD       SI,1             ; SI寄存器加1(地址后移一位)
    98 00007CB7 3C 00                                   CMP       AL,0             ; 比较一下AL和0两个数
    99 00007CB9 74 ED                                   JE        fin              ; 如果AL是0(内存中的数据读完了),就跳转到fin
   100 00007CBB B4 0E                                   MOV       AH,0x0e          ; 否则就显示一个文字
   101 00007CBD BB 000F                                 MOV       BX,15            ; 指定字符颜色
   102 00007CC0 CD 10                                   INT       0x10             ; 调用显卡BIOS
   103 00007CC2 EB EE                                   JMP       putloop          ; 进行下一个putloop操作
   104 00007CC4                                 
   105 00007CC4                                 msg:
   106 00007CC4 0A                                      DB       0x0a              ; 换行
   107 00007CC5 0A                                      DB       0x0a              ; 换行
   108 00007CC6 45 72 72 6F 72 3A 20 46 61 69           DB       "Error: Failed to load disk."
       00007CD0 6C 65 64 20 74 6F 20 6C 6F 61 
       00007CDA 64 20 64 69 73 6B 2E 
   109 00007CE1 0A                                      DB       0x0a              ; 换行
   110 00007CE2 00                                      DB       0                 ; 保存一个0,让putloop读到它时停止
   111 00007CE3                                 
   112 00007CE3 00 00 00 00 00 00 00 00 00 00           RESB     0x7dfe-$          ; 用0占位直到0x7dfe这个地方
       00007CED 00 00 00 00 00 00 00 00 00 00 
       00007CF7 00 00 00 00 00 00 00 00 00 00 
       00007D01 00 00 00 00 00 00 00 00 00 00 
       00007D0B 00 00 00 00 00 00 00 00 00 00 
       00007D15 00 00 00 00 00 00 00 00 00 00 
       00007D1F 00 00 00 00 00 00 00 00 00 00 
       00007D29 00 00 00 00 00 00 00 00 00 00 
       00007D33 00 00 00 00 00 00 00 00 00 00 
       00007D3D 00 00 00 00 00 00 00 00 00 00 
       00007D47 00 00 00 00 00 00 00 00 00 00 
       00007D51 00 00 00 00 00 00 00 00 00 00 
       00007D5B 00 00 00 00 00 00 00 00 00 00 
       00007D65 00 00 00 00 00 00 00 00 00 00 
       00007D6F 00 00 00 00 00 00 00 00 00 00 
       00007D79 00 00 00 00 00 00 00 00 00 00 
       00007D83 00 00 00 00 00 00 00 00 00 00 
       00007D8D 00 00 00 00 00 00 00 00 00 00 
       00007D97 00 00 00 00 00 00 00 00 00 00 
       00007DA1 00 00 00 00 00 00 00 00 00 00 
       00007DAB 00 00 00 00 00 00 00 00 00 00 
       00007DB5 00 00 00 00 00 00 00 00 00 00 
       00007DBF 00 00 00 00 00 00 00 00 00 00 
       00007DC9 00 00 00 00 00 00 00 00 00 00 
       00007DD3 00 00 00 00 00 00 00 00 00 00 
       00007DDD 00 00 00 00 00 00 00 00 00 00 
       00007DE7 00 00 00 00 00 00 00 00 00 00 
       00007DF1 00 00 00 00 00 00 00 00 00 00 
       00007DFB 00 00 00 
   113 00007DFE                                 
   114 00007DFE 55 AA                                   DB       0x55, 0xaa        ; 告诉BIOS这个磁盘是可启动的